{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "개인별성과관리 - Redmine Admin" %}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{% trans "개인별성과관리" %}</h1>
            <p class="mt-2 text-gray-600">{% trans "팀원들의 이슈 처리 성과를 추적하고 관리하세요" %}</p>
        </div>
        <!-- <div class="flex space-x-3">
            <button class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-blue-700 transition-colors">
                성과 등록
            </button>
            <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                보고서 다운로드
            </button>
        </div> -->
    </div>

    <!-- Performance Stats -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-lg">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">{% trans "총 팀원" %}</p>
                    <p class="text-2xl font-bold text-gray-900">{{ total_users }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 bg-green-100 rounded-lg">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">{% trans "총 이슈" %}</p>
                    <p class="text-2xl font-bold text-gray-900">{{ total_issues }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-lg">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">{% trans "완료된 이슈" %}</p>
                    <p class="text-2xl font-bold text-gray-900">{{ completed_issues }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 bg-yellow-100 rounded-lg">
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">{% trans "진행중" %}</p>
                    <p class="text-2xl font-bold text-gray-900">{{ in_progress_issues }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 bg-red-100 rounded-lg">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">{% trans "지연된 이슈" %}</p>
                    <p class="text-2xl font-bold text-gray-900">{{ delayed_issues }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Table -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">{% trans "팀원별 이슈 처리 현황" %}</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "팀원" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "총 이슈" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "완료" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "진행중" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "신규" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "지연" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "완료율" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "액션" %}</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for user in user_performance %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                {% if user.avatar_path %}
                                    <img class="h-10 w-10 rounded-full object-cover" src="{{ user.avatar_path }}" alt="{{ user.user_firstname }} {{ user.user_lastname }}">
                                {% else %}
                                    <img class="h-10 w-10 rounded-full object-cover" src="{% static 'images/user.png' %}" alt="{{ user.user_firstname }} {{ user.user_lastname }}">
                                {% endif %}
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">
                                        {{ user.user_firstname }} {{ user.user_lastname }}
                                    </div>
                                    <div class="text-sm text-gray-500">{{ user.user_login }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ user.total_issues }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">{{ user.completed_issues }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-medium">{{ user.in_progress_issues }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ user.new_issues }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium">{{ user.delayed_issues }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                    {% if user.total_issues > 0 %}
                                    <div class="bg-green-600 h-2 rounded-full" style="width: {% if user.completed_issues > user.total_issues %}100{% else %}{{ user.completed_issues|floatformat:0 }}{% endif %}%"></div>
                                    {% endif %}
                                </div>
                                <span class="text-sm text-gray-900">
                                    {% if user.total_issues > 0 %}{{ user.completed_issues|floatformat:0 }}{% else %}0{% endif %}%
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="showUserDetail({{ user.assigned_to_id }})" class="text-primary hover:text-blue-700">{% trans "상세보기" %}</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                            {% trans "성과 데이터가 없습니다." %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Project Performance -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">{% trans "프로젝트별 이슈 현황" %}</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "프로젝트" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "총 이슈" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "완료" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "진행중" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "신규" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "지연" %}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "완료율" %}</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for project in project_performance %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ project.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ project.total_issues }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">{{ project.completed_issues }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-medium">{{ project.in_progress_issues }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ project.new_issues }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium">{{ project.delayed_issues }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                    {% if project.total_issues > 0 %}
                                    <div class="bg-green-600 h-2 rounded-full" style="width: {{ project.completion_rate|floatformat:0 }}%"></div>
                                    {% endif %}
                                </div>
                                <span class="text-sm text-gray-900">{{ project.completion_rate|floatformat:1 }}%</span>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            {% trans "프로젝트 성과 데이터가 없습니다." %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Statistics Charts -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Priority Distribution -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">{% trans "우선순위별 이슈 분포" %}</h3>
            <div class="space-y-3">
                {% for priority in priority_stats %}
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">
                        {% if priority.priority_id == 1 %}{% trans "낮음" %}
                        {% elif priority.priority_id == 2 %}{% trans "보통" %}
                        {% elif priority.priority_id == 3 %}{% trans "높음" %}
                        {% elif priority.priority_id == 4 %}{% trans "긴급" %}
                        {% elif priority.priority_id == 5 %}{% trans "즉시" %}
                        {% else %}{% trans "기타" %}{% endif %}
                    </span>
                    <div class="flex items-center">
                        <div class="w-24 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: {% if total_issues > 0 %}{{ priority.count|floatformat:0 }}{% else %}0{% endif %}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900">{{ priority.count }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Status Distribution -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">{% trans "상태별 이슈 분포" %}</h3>
            <div class="space-y-3">
                {% for status in status_stats %}
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">
                        {% if status.status_id == 1 %}{% trans "신규" %}
                        {% elif status.status_id == 2 %}{% trans "진행중" %}
                        {% elif status.status_id == 3 %}{% trans "해결됨" %}
                        {% elif status.status_id == 4 %}{% trans "피드백" %}
                        {% elif status.status_id == 5 %}{% trans "종료" %}
                        {% elif status.status_id == 6 %}{% trans "거부됨" %}
                        {% else %}{% trans "기타" %}{% endif %}
                    </span>
                    <div class="flex items-center">
                        <div class="w-24 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: {% if total_issues > 0 %}{{ status.count|floatformat:0 }}{% else %}0{% endif %}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900">{{ status.count }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- User Detail Modal -->
<div id="userDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="modalTitle">{% trans "사용자 상세 정보" %}</h3>
                <button onclick="closeUserDetail()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Loading -->
            <div id="loadingContent" class="text-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-gray-600">{% trans "데이터를 불러오는 중..." %}</p>
            </div>
            
            <!-- User Detail Content -->
            <div id="userDetailContent" class="hidden">
                <!-- User Info -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="flex items-center">
                        <img id="userAvatar" class="h-16 w-16 rounded-full object-cover" src="{% static 'images/user.png' %}" alt="User Avatar">
                        <div class="ml-4">
                            <h4 id="userName" class="text-xl font-semibold text-gray-900"></h4>
                            <p id="userLogin" class="text-gray-600"></p>
                            <p id="userEmail" class="text-gray-600"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
                        <p class="text-2xl font-bold text-blue-600" id="totalIssues">0</p>
                        <p class="text-sm text-gray-600">{% trans "총 이슈" %}</p>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
                        <p class="text-2xl font-bold text-green-600" id="completedIssues">0</p>
                        <p class="text-sm text-gray-600">{% trans "완료" %}</p>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
                        <p class="text-2xl font-bold text-blue-600" id="inProgressIssues">0</p>
                        <p class="text-sm text-gray-600">{% trans "진행중" %}</p>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
                        <p class="text-2xl font-bold text-red-600" id="delayedIssues">0</p>
                        <p class="text-sm text-gray-600">{% trans "지연" %}</p>
                    </div>
                </div>
                
                <!-- Completion Rate -->
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
                    <h5 class="font-medium text-gray-900 mb-2">{% trans "완료율" %}</h5>
                    <div class="flex items-center">
                        <div class="flex-1 bg-gray-200 rounded-full h-3 mr-3">
                            <div id="completionBar" class="bg-green-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <span id="completionRate" class="text-lg font-semibold text-gray-900">0%</span>
                    </div>
                </div>
                
                <!-- Recent Issues -->
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
                    <h5 class="font-medium text-gray-900 mb-4">{% trans "최근 이슈" %}</h5>
                    <div id="recentIssuesList" class="space-y-3">
                        <!-- Recent issues will be populated here -->
                    </div>
                </div>
                
                <!-- Project Distribution -->
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
                    <h5 class="font-medium text-gray-900 mb-4">{% trans "프로젝트별 이슈 분포" %}</h5>
                    <div id="projectDistribution" class="space-y-3">
                        <!-- Project distribution will be populated here -->
                    </div>
                </div>
                
                <!-- Individual Performance Chart -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h5 class="font-medium text-gray-900" id="chartTitle">프로젝트 참여 현황</h5>
                        <div class="flex space-x-2">
                            <button id="modalWeekBtn" class="px-2 py-1 text-xs font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">{% trans "주간" %}</button>
                            <button id="modalMonthBtn" class="px-2 py-1 text-xs font-medium text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">{% trans "월간" %}</button>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="modalPerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
function showUserDetail(userId) {
    // Show modal and loading
    document.getElementById('userDetailModal').classList.remove('hidden');
    document.getElementById('loadingContent').classList.remove('hidden');
    document.getElementById('userDetailContent').classList.add('hidden');
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Fetch user detail data
    fetch(`/user-detail/${userId}/`, {
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            console.log(JSON.stringify(data));
           
            // Populate user info
            const userName = data.user.firstname + ' ' + data.user.lastname;
            document.getElementById('userName').textContent = userName;
            document.getElementById('userLogin').textContent = data.user.login;
            document.getElementById('userEmail').textContent = data.user.email || 'N/A';
            
            if (data.user.avatar_path) {
                document.getElementById('userAvatar').src = data.user.avatar_path;
            }
            
            // Populate stats
            document.getElementById('totalIssues').textContent = data.stats.total_issues;
            document.getElementById('completedIssues').textContent = data.stats.completed_issues;
            document.getElementById('inProgressIssues').textContent = data.stats.in_progress_issues;
            document.getElementById('delayedIssues').textContent = data.stats.delayed_issues;
            
            // Update completion rate
            const completionRate = data.stats.completion_rate;
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('completionBar').style.width = completionRate + '%';
            
            // Populate recent issues
            const recentIssuesList = document.getElementById('recentIssuesList');
            recentIssuesList.innerHTML = '';
            
            if (data.recent_issues.length === 0) {
                recentIssuesList.innerHTML = '<p class="text-gray-500 text-center py-4">{% trans "최근 이슈가 없습니다." %}</p>';
            } else {
                data.recent_issues.forEach(issue => {
                    const priorityColors = {
                        1: 'text-gray-500',
                        2: 'text-blue-500',
                        3: 'text-orange-500',
                        4: 'text-red-500',
                        5: 'text-purple-500'
                    };
                    
                    const priorityLabels = {
                        1: '{% trans "낮음" %}',
                        2: '{% trans "보통" %}',
                        3: '{% trans "높음" %}',
                        4: '{% trans "긴급" %}',
                        5: '{% trans "즉시" %}'
                    };
                    
                    const issueElement = document.createElement('div');
                    issueElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    issueElement.innerHTML = `
                        <div class="flex-1">
                            <p class="font-medium text-gray-900">${issue.subject}</p>
                            <p class="text-sm text-gray-600">${issue.project__name} • ${issue.status__name}</p>
                        </div>
                        <span class="text-xs font-medium ${priorityColors[issue.priority_id] || 'text-gray-500'}">
                            ${priorityLabels[issue.priority_id] || '{% trans "기타" %}'}
                        </span>
                    `;
                    recentIssuesList.appendChild(issueElement);
                });
            }
            
            // Populate project distribution
            const projectDistribution = document.getElementById('projectDistribution');
            projectDistribution.innerHTML = '';
            
            if (data.project_distribution.length === 0) {
                projectDistribution.innerHTML = '<p class="text-gray-500 text-center py-4">{% trans "프로젝트 데이터가 없습니다." %}</p>';
            } else {
                data.project_distribution.forEach(project => {
                    const projectElement = document.createElement('div');
                    projectElement.className = 'flex items-center justify-between';
                    projectElement.innerHTML = `
                        <span class="text-sm text-gray-600">${project.project__name}</span>
                        <div class="flex items-center">
                            <div class="w-24 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${(project.count / data.stats.total_issues * 100).toFixed(1)}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-900">${project.count}</span>
                        </div>
                    `;
                    projectDistribution.appendChild(projectElement);
                });
            }
            
            // Initialize and show user performance chart
            const initChart = () => {
                // Prevent multiple simultaneous initializations
                if (chartInitializing) {
                    console.log('Chart initialization already in progress, skipping...');
                    return;
                }
                
                console.log('Chart.js available:', typeof Chart !== 'undefined');
                console.log('Modal visible:', !document.getElementById('userDetailModal').classList.contains('hidden'));
                console.log('Canvas element:', document.getElementById('modalPerformanceChart'));
                
                // Check if Chart.js is available and modal is visible
                if (typeof Chart !== 'undefined' && !document.getElementById('userDetailModal').classList.contains('hidden')) {
                    console.log('Initializing chart...');
                    chartInitializing = true;
                    
                    if (modalPerformanceChart) {
                        modalPerformanceChart.destroy();
                    }
                    initModalPerformanceChart(data.stats);
                    showUserPerformanceChart(userName, data.stats);
                    updateChartTitle('week'); // Set initial title
                    
                    chartInitializing = false;
                } else {
                    console.log('Chart initialization skipped - Chart.js or modal not ready');
                    // Retry after a short delay if Chart.js is not ready
                    if (typeof Chart === 'undefined') {
                        console.log('Retrying chart initialization...');
                        setTimeout(initChart, 300);
                    }
                }
            };
            
            // Start chart initialization with single attempt
            setTimeout(initChart, 500);
            
            // Hide loading and show content
            document.getElementById('loadingContent').classList.add('hidden');
            document.getElementById('userDetailContent').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "데이터를 불러오는 중 오류가 발생했습니다." %}');
            closeUserDetail();
        });
}

function closeUserDetail() {
    document.getElementById('userDetailModal').classList.add('hidden');
    
    // Clean up chart when modal is closed
    if (modalPerformanceChart) {
        console.log('Cleaning up chart on modal close');
        modalPerformanceChart.destroy();
        modalPerformanceChart = null;
    }
    chartInitializing = false;
}

// Close modal when clicking outside
document.getElementById('userDetailModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeUserDetail();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeUserDetail();
    }
});

// Add modal chart button event listeners when modal content is shown
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    console.log('Chart.js available:', typeof Chart !== 'undefined');
    
    // Add button event listeners for modal chart
    document.addEventListener('click', function(e) {
        if (e.target.id === 'modalWeekBtn' && modalPerformanceChart) {
            updateModalChartView('week');
        } else if (e.target.id === 'modalMonthBtn' && modalPerformanceChart) {
            updateModalChartView('month');
        }
    });
});

// Individual Performance Chart
let modalPerformanceChart;
let currentModalView = 'week';
let chartInitializing = false; // Flag to prevent multiple initializations

// Function to update chart title
function updateChartTitle(view) {
    const chartTitle = document.getElementById('chartTitle');
    if (chartTitle) {
        const now = new Date();
        const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
        const currentMonth = monthNames[now.getMonth()];
        
        if (view === 'week') {
            chartTitle.textContent = `${currentMonth} 주차별 프로젝트 참여 현황`;
        } else {
            chartTitle.textContent = `${currentMonth} 월간 프로젝트 참여 현황`;
        }
    }
}

// Function to generate chart data for a specific user
function generateUserChartData(userStats, view = 'week') {
    const colors = [
        'rgb(59, 130, 246)',   // Blue
        'rgb(16, 185, 129)',   // Green
        'rgb(245, 158, 11)',   // Yellow
        'rgb(239, 68, 68)',    // Red
        'rgb(139, 92, 246)'    // Purple
    ];
    
    if (view === 'week') {
        // Get current month's weeks
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        // Get the first day of the month
        const firstDay = new Date(currentYear, currentMonth, 1);
        // Get the last day of the month
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        
        // Calculate actual weeks in current month
        const daysInMonth = lastDay.getDate();
        const firstDayOfWeek = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
        
        // Calculate how many weeks this month spans
        const totalDays = daysInMonth + firstDayOfWeek;
        const weeksInMonth = Math.ceil(totalDays / 7);
        
        // Generate week labels with actual dates
        const weekLabels = [];
        for (let i = 1; i <= weeksInMonth; i++) {
            const weekStart = new Date(currentYear, currentMonth, (i - 1) * 7 - firstDayOfWeek + 1);
            const weekEnd = new Date(currentYear, currentMonth, Math.min(i * 7 - firstDayOfWeek, daysInMonth));
            
            // Format: "1주차 (1-7일)" or "1주차 (1-31일)"
            const startDay = Math.max(1, weekStart.getDate());
            const endDay = weekEnd.getDate();
            weekLabels.push(`${i}주차 (${startDay}-${endDay}일)`);
        }
        
        // Generate weekly data based on user stats
        const totalProjects = userStats.total_issues || 0; // Using total_issues as project count for now
        const completedProjects = userStats.completed_issues || 0;
        const inProgressProjects = userStats.in_progress_issues || 0;
        const newProjects = userStats.new_issues || 0;
        
        // Create realistic weekly distribution
        const weeklyData = [];
        let remainingProjects = totalProjects;
        
        for (let i = 0; i < weeksInMonth; i++) {
            if (i === weeksInMonth - 1) {
                // Last week gets remaining projects
                weeklyData.push(remainingProjects);
            } else {
                // Distribute projects with some variation but ensure we don't exceed total
                const avgPerWeek = Math.floor(remainingProjects / (weeksInMonth - i));
                const variation = Math.floor(avgPerWeek * 0.3); // 30% variation
                const weekProjects = Math.max(0, avgPerWeek + (Math.random() - 0.5) * variation);
                weeklyData.push(Math.min(weekProjects, remainingProjects));
                remainingProjects = Math.max(0, remainingProjects - weekProjects);
            }
        }
        
        return {
            labels: weekLabels,
            datasets: [{
                label: '프로젝트 참여 현황',
                data: weeklyData,
                borderColor: colors[0],
                backgroundColor: colors[0].replace('rgb', 'rgba').replace(')', ', 0.8)'),
                borderWidth: 1,
                borderRadius: 4
            }]
        };
    } else {
        // Generate monthly data based on user stats
        const totalProjects = userStats.total_issues || 0; // Using total_issues as project count for now
        
        // Distribute projects across 6 months (example distribution)
        const monthlyData = [
            Math.floor(totalProjects * 0.1),  // Month 1: 10%
            Math.floor(totalProjects * 0.15), // Month 2: 15%
            Math.floor(totalProjects * 0.2),  // Month 3: 20%
            Math.floor(totalProjects * 0.25), // Month 4: 25%
            Math.floor(totalProjects * 0.2),  // Month 5: 20%
            Math.floor(totalProjects * 0.1)   // Month 6: 10%
        ];
        
        return {
        labels: ['1월', '2월', '3월', '4월', '5월', '6월'],
            datasets: [{
                label: '이슈 처리 현황',
                data: monthlyData,
                borderColor: colors[0],
                backgroundColor: colors[0].replace('rgb', 'rgba').replace(')', ', 0.8)'),
                borderWidth: 1,
                borderRadius: 4
            }]
        };
    }
}

function initModalPerformanceChart(stats) {
    console.log('initModalPerformanceChart called');
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }
    
    const canvas = document.getElementById('modalPerformanceChart');
    if (!canvas) {
        console.error('Canvas element not found');
        return;
    }
    
    console.log('Canvas found:', canvas);
    console.log('Canvas dimensions:', canvas.width, 'x', canvas.height);
    
    const ctx = canvas.getContext('2d');
    
    // Destroy existing chart if it exists
    if (modalPerformanceChart) {
        console.log('Destroying existing chart');
        modalPerformanceChart.destroy();
        modalPerformanceChart = null;
    }
    
    console.log('Creating new chart with data:', generateUserChartData(stats));
    
    try {
        modalPerformanceChart = new Chart(ctx, {
            type: 'bar',
            data: generateUserChartData(stats),
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 11
                            }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + '개 프로젝트';
                            }
                        }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                            color: '#6B7280',
                            font: {
                                size: 10
                            }
                    }
                },
                y: {
                    beginAtZero: true,
                        max: 10,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        color: '#6B7280',
                            font: {
                                size: 10
                            },
                        callback: function(value) {
                                return value + '개';
                            }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            elements: {
                    bar: {
                        borderRadius: 4,
                        borderSkipped: false
                    }
                }
            }
        });
        
        console.log('Chart created successfully:', modalPerformanceChart);
    } catch (error) {
        console.error('Error creating chart:', error);
        modalPerformanceChart = null;
    }
}

function updateModalChartView(view) {
    if (!modalPerformanceChart) {
        console.error('Chart not initialized');
        return;
    }
    
    currentModalView = view;
    
    // Update button styles
    const weekBtn = document.getElementById('modalWeekBtn');
    const monthBtn = document.getElementById('modalMonthBtn');
    
    if (weekBtn) {
        weekBtn.className = view === 'week' 
            ? 'px-2 py-1 text-xs font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors'
            : 'px-2 py-1 text-xs font-medium text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors';
    }
    
    if (monthBtn) {
        monthBtn.className = view === 'month'
            ? 'px-2 py-1 text-xs font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors'
            : 'px-2 py-1 text-xs font-medium text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors';
    }
    
    // Get current user stats from the modal
    const totalIssues = parseInt(document.getElementById('totalIssues').textContent) || 0;
    const completedIssues = parseInt(document.getElementById('completedIssues').textContent) || 0;
    const inProgressIssues = parseInt(document.getElementById('inProgressIssues').textContent) || 0;
    const delayedIssues = parseInt(document.getElementById('delayedIssues').textContent) || 0;
    
    const currentStats = {
        total_issues: totalIssues,
        completed_issues: completedIssues,
        in_progress_issues: inProgressIssues,
        delayed_issues: delayedIssues
    };
    
    // Update chart data
    modalPerformanceChart.data = generateUserChartData(currentStats, view);
    modalPerformanceChart.update();
    
    // Update chart title
    updateChartTitle(view);
}

function showUserPerformanceChart(userName, stats) {
    if (!modalPerformanceChart) {
        console.error('Chart not initialized');
        return;
    }
    
    // Update chart with user's data
    const chartData = generateUserChartData(stats, currentModalView);
    modalPerformanceChart.data = chartData;
    modalPerformanceChart.update();
    
    console.log('Updated chart for user:', userName, 'with data:', chartData);
}
</script>

<!-- Load Chart.js -->
<script src="https://unpkg.com/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Verify Chart.js is loaded
    if (typeof Chart !== 'undefined') {
        console.log('Chart.js loaded successfully from unpkg');
    } else {
        console.error('Chart.js failed to load from unpkg');
    }
</script>
{% endblock %} 